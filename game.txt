-- 1. 게임 방 테이블
create table rooms (
  id uuid default gen_random_uuid() primary key,
  code text unique not null, -- 접속 코드 (예: 'LOVE-IT')
  status text default 'WAITING', -- 'WAITING', 'PLAYING', 'FINISHED'
  current_round int default 1,
  current_drawer_id uuid -- 현재 그림 그리는 사람
);

-- 2. 플레이어 테이블
create table players (
  id uuid default gen_random_uuid() primary key,
  room_id uuid references rooms(id),
  name text not null,
  gender text not null, -- 'M', 'F'
  team_id int, -- 1, 2, 3 (팀 번호)
  score int default 0,
  is_host boolean default false
);

-- 3. 채팅/정답 로그 (정답 판별용)
create table chats (
  id bigint generated by default as identity primary key,
  room_id uuid references rooms(id),
  player_id uuid references players(id),
  message text not null,
  created_at timestamptz default now()
);

-- 1. rooms 테이블: 게임 진행 상황을 저장할 컬럼들 추가
ALTER TABLE rooms 
ADD COLUMN IF NOT EXISTS current_turn_order int default 1, -- 현재 턴 (1~9)
ADD COLUMN IF NOT EXISTS current_word text,                -- 현재 정답 단어
ADD COLUMN IF NOT EXISTS round_start_at timestamptz,       -- 라운드 시작 시간 (타이머 기준)
ADD COLUMN IF NOT EXISTS total_rounds int default 9,       -- 총 라운드 수
ADD COLUMN IF NOT EXISTS is_game_over boolean default false; -- 게임 종료 여부

-- 2. players 테이블: 입장 순서와 점수 추가
ALTER TABLE players
ADD COLUMN IF NOT EXISTS turn_order int,      -- 입장 순서 (1, 2, 3...)
ADD COLUMN IF NOT EXISTS score int default 0; -- 획득 점수


-- 라운드를 끝내고 다음 사람으로 넘기는 마법의 함수
CREATE OR REPLACE FUNCTION finish_round(
  p_room_id uuid,
  p_winner_id uuid, -- 못 맞췄으면 NULL
  p_score_add int   -- 추가할 점수 (0 또는 계산된 점수)
)
RETURNS void AS $$
DECLARE
  v_next_turn int;
  v_total_rounds int;
BEGIN
  -- 1. 정답자 점수 올려주기 (정답자가 있을 때만)
  IF p_winner_id IS NOT NULL THEN
    UPDATE players 
    SET score = score + p_score_add 
    WHERE id = p_winner_id;
  END IF;

  -- 2. 현재 방 정보 가져오기
  SELECT current_turn_order, total_rounds 
  INTO v_next_turn, v_total_rounds
  FROM rooms 
  WHERE id = p_room_id;

  -- 3. 다음 턴 계산 (9번이면 게임 종료, 아니면 +1)
  IF v_next_turn >= v_total_rounds THEN
    -- 게임 종료 처리
    UPDATE rooms 
    SET status = 'FINISHED', is_game_over = true 
    WHERE id = p_room_id;
  ELSE
    -- 다음 라운드 준비 (단어는 비워두고, 시간 리셋)
    UPDATE rooms 
    SET 
      current_turn_order = current_turn_order + 1,
      current_word = NULL,        -- 다음 단어는 출제자가 고르거나 랜덤 할당될 때까지 대기
      round_start_at = now()      -- 시간 리셋
    WHERE id = p_room_id;
  END IF;
END;
$$ LANGUAGE plpgsql;